#!/bin/bash
set -e

OUTPUT_DIR="samples_advanced"
mkdir -p "$OUTPUT_DIR"

echo "ðŸ”¥ Generating 500 ADVANCED synthetic malware samples"
echo "   - Multiple languages: Rust, C, C++, Go"
echo "   - Obfuscation techniques"
echo "   - Anti-debug patterns"
echo "   - Polymorphic variants"
echo ""

#==============================================================================
# RUST: Advanced obfuscated samples
#==============================================================================

echo "ðŸ“¦ Creating Rust samples (1-100)..."

for i in $(seq 1 100); do
cat > /tmp/rust_adv_${i}.rs << EOF
// Obfuscated ransomware simulator
use std::collections::hash_map::DefaultHasher;
use std::hash::{Hash, Hasher};

#[inline(never)]
fn decrypt_string(encrypted: &[u8]) -> String {
    encrypted.iter().map(|b| (b ^ 0xAA) as char).collect()
}

fn main() {
    // Encrypted strings (XOR obfuscation)
    let enc_ransom = vec![0xc8, 0xcb, 0xd8, 0xd7]; // "YOUR"
    let enc_bitcoin = vec![0xc2, 0xd4, 0xc3]; // "BTC"
    
    let _msg = decrypt_string(&enc_ransom);
    let _crypto = decrypt_string(&enc_bitcoin);
    
    // High entropy data (looks packed/encrypted)
    let packed_data: Vec<u8> = (0..50000)
        .map(|i| ((i * 31 + 17) % 256) as u8)
        .collect();
    
    // Simulate file discovery with obfuscated paths
    let mut paths = Vec::new();
    for ext in &[".pdf", ".docx", ".xlsx", ".jpg"] {
        paths.push(format!("/home/user/Documents/*{}", ext));
    }
    
    // Crypto operations (AES-like pattern)
    for chunk in packed_data.chunks($((i * 16))) {
        let mut hasher = DefaultHasher::new();
        chunk.hash(&mut hasher);
        let _ = hasher.finish();
    }
    
    // Anti-debug: timing check
    let start = std::time::Instant::now();
    std::thread::sleep(std::time::Duration::from_micros(1));
    if start.elapsed().as_micros() > 10000 {
        return; // Debugger detected
    }
    
    // Syscalls
    for _ in 0..$((30 + i)) {
        std::fs::read_to_string("/proc/cpuinfo").ok();
    }
}
EOF
done

#==============================================================================
# C: Low-level malware patterns
#==============================================================================

echo "ðŸ“¦ Creating C samples (101-200)..."

for i in $(seq 101 200); do
cat > /tmp/c_adv_${i}.c << EOF
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/ptrace.h>

// String obfuscation
char* xor_decrypt(unsigned char* data, int len) {
    static char buf[256];
    for(int i = 0; i < len; i++) {
        buf[i] = data[i] ^ 0xAA;
    }
    buf[len] = 0;
    return buf;
}

// Anti-debug
int detect_debugger() {
    if (ptrace(0, 0, 0, 0) == -1) {
        return 1; // Debugger detected
    }
    return 0;
}

int main() {
    // Obfuscated strings
    unsigned char enc_shell[] = {0xe5, 0xc4, 0xc8, 0xce, 0xe5, 0xd1, 0xc1}; // "/bin/sh"
    unsigned char enc_curl[] = {0xc9, 0xd5, 0xd2, 0xd6}; // "curl"
    
    char* shell = xor_decrypt(enc_shell, 7);
    char* net = xor_decrypt(enc_curl, 4);
    
    // High entropy buffer (looks packed)
    unsigned char packed[$((i * 100))];
    for(int j = 0; j < $((i * 100)); j++) {
        packed[j] = (j * 17 + $i) % 256;
    }
    
    // Anti-debug check
    if(detect_debugger()) {
        return 0;
    }
    
    // Network-like patterns
    char* c2_servers[] = {
        "http://192.0.2.$((i % 255)):8080",
        "tcp://198.51.100.$((i % 255)):4444",
        NULL
    };
    
    // File operations
    FILE* f = fopen("/proc/version", "r");
    if(f) {
        char buf[1024];
        for(int k = 0; k < $((20 + i % 50)); k++) {
            fread(buf, 1, sizeof(buf), f);
            fseek(f, 0, SEEK_SET);
        }
        fclose(f);
    }
    
    return 0;
}
EOF
done

#==============================================================================
# C++: Object-oriented malware patterns
#==============================================================================

echo "ðŸ“¦ Creating C++ samples (201-300)..."

for i in $(seq 201 300); do
cat > /tmp/cpp_adv_${i}.cpp << EOF
#include <iostream>
#include <vector>
#include <string>
#include <fstream>
#include <thread>
#include <chrono>

// Polymorphic malware base class
class MalwareBase {
protected:
    std::vector<unsigned char> encrypted_data;
    
    std::string decrypt(const std::vector<unsigned char>& data) {
        std::string result;
        for(auto byte : data) {
            result += static_cast<char>(byte ^ 0x$((i % 256)));
        }
        return result;
    }
    
public:
    virtual void execute() = 0;
    virtual ~MalwareBase() {}
};

// Ransomware variant
class Ransomware : public MalwareBase {
private:
    std::vector<std::string> target_extensions{
        ".pdf", ".docx", ".xlsx", ".pptx", ".jpg", ".png"
    };
    
    void simulate_encryption() {
        for(int i = 0; i < $((i * 10)); i++) {
            encrypted_data.push_back((i * 31) % 256);
        }
    }
    
public:
    void execute() override {
        // Obfuscated ransom note
        std::vector<unsigned char> note{0xc8, 0xcb, 0xd8, 0xd7}; // "YOUR"
        std::string msg = decrypt(note);
        
        simulate_encryption();
        
        // File discovery
        std::ifstream proc("/proc/cpuinfo");
        for(int i = 0; i < $((30 + i % 50)); i++) {
            std::string line;
            std::getline(proc, line);
            proc.seekg(0);
        }
    }
};

// Anti-debug timing
bool check_timing() {
    auto start = std::chrono::high_resolution_clock::now();
    std::this_thread::sleep_for(std::chrono::microseconds(1));
    auto end = std::chrono::high_resolution_clock::now();
    auto duration = std::chrono::duration_cast<std::chrono::microseconds>(end - start);
    return duration.count() < 10000;
}

int main() {
    if(!check_timing()) {
        return 1; // Debugger detected
    }
    
    Ransomware* malware = new Ransomware();
    malware->execute();
    delete malware;
    
    return 0;
}
EOF
done

#==============================================================================
# GO: Concurrent malware patterns
#==============================================================================

echo "ðŸ“¦ Creating Go samples (301-400)..."

for i in $(seq 301 400); do
cat > /tmp/go_adv_${i}.go << EOF
package main

import (
    "crypto/sha256"
    "fmt"
    "io/ioutil"
    "os"
    "runtime"
    "sync"
    "time"
)

// Obfuscated strings
func xorDecrypt(data []byte, key byte) string {
    result := make([]byte, len(data))
    for i, b := range data {
        result[i] = b ^ key
    }
    return string(result)
}

// Anti-debug timing
func detectDebugger() bool {
    start := time.Now()
    time.Sleep(1 * time.Microsecond)
    elapsed := time.Since(start)
    return elapsed < 10*time.Millisecond
}

// Concurrent file scanner
func scanFiles(wg *sync.WaitGroup, id int) {
    defer wg.Done()
    
    for i := 0; i < $((10 + i % 20)); i++ {
        ioutil.ReadFile("/proc/cpuinfo")
    }
}

// Network beacon simulator
func beacon(c2 string) {
    for i := 0; i < $((i % 50)); i++ {
        time.Sleep(100 * time.Millisecond)
        // Fake beacon (no actual network)
        _ = fmt.Sprintf("Beacon to %s", c2)
    }
}

func main() {
    // Anti-debug
    if !detectDebugger() {
        os.Exit(1)
    }
    
    // Obfuscated C2
    encC2 := []byte{0xe8, 0xd4, 0xd4, 0xd0} // "http"
    c2 := xorDecrypt(encC2, 0xAA) + "://192.0.2.$((i % 255)):8080"
    
    // High entropy data
    packed := make([]byte, $((i * 100)))
    for j := range packed {
        packed[j] = byte((j * 17 + $i) % 256)
    }
    
    // Crypto operations
    for k := 0; k < $((i % 100)); k++ {
        sha256.Sum256(packed)
    }
    
    // Concurrent operations (worm-like)
    var wg sync.WaitGroup
    workers := runtime.NumCPU()
    for i := 0; i < workers; i++ {
        wg.Add(1)
        go scanFiles(&wg, i)
    }
    
    // Beacon in background
    go beacon(c2)
    
    wg.Wait()
}
EOF
done

#==============================================================================
# RUST: Advanced polymorphic variants
#==============================================================================

echo "ðŸ“¦ Creating polymorphic Rust samples (401-500)..."

for i in $(seq 401 500); do
variant=$((i % 5))
case $variant in
    0) PATTERN="keylogger" ;;
    1) PATTERN="backdoor" ;;
    2) PATTERN="rootkit" ;;
    3) PATTERN="botnet" ;;
    4) PATTERN="miner" ;;
esac

cat > /tmp/rust_poly_${i}.rs << EOF
// Polymorphic variant: $PATTERN
#![allow(unused)]
use std::io::Read;

const XOR_KEY: u8 = 0x$((i % 256));

struct Payload {
    encrypted: Vec<u8>,
    key: u8,
}

impl Payload {
    fn decrypt(&self) -> Vec<u8> {
        self.encrypted.iter().map(|b| b ^ self.key).collect()
    }
    
    fn execute(&self) {
        let data = self.decrypt();
        // Polymorphic execution paths
        match "$PATTERN" {
            "keylogger" => self.simulate_keylog(),
            "backdoor" => self.simulate_backdoor(),
            "rootkit" => self.simulate_rootkit(),
            "botnet" => self.simulate_botnet(),
            "miner" => self.simulate_miner(),
            _ => {}
        }
    }
    
    fn simulate_keylog(&self) {
        for _ in 0..$((i % 50)) {
            std::env::var("USER").ok();
        }
    }
    
    fn simulate_backdoor(&self) {
        let _ports = vec![22, 23, 3389, $((4444 + i % 1000))];
    }
    
    fn simulate_rootkit(&self) {
        std::env::set_var("LD_PRELOAD", "/tmp/.hide.so");
    }
    
    fn simulate_botnet(&self) {
        let _c2 = format!("http://bot{}.onion:8080", $i);
    }
    
    fn simulate_miner(&self) {
        use std::collections::hash_map::DefaultHasher;
        use std::hash::{Hash, Hasher};
        for j in 0..$((i * 5)) {
            let mut h = DefaultHasher::new();
            j.hash(&mut h);
            h.finish();
        }
    }
}

fn main() {
    let payload = Payload {
        encrypted: (0..$((i * 100))).map(|x| ((x * 17) % 256) as u8).collect(),
        key: XOR_KEY,
    };
    
    // Anti-VM check
    if let Ok(cpu) = std::fs::read_to_string("/proc/cpuinfo") {
        if cpu.contains("QEMU") || cpu.contains("VirtualBox") {
            return;
        }
    }
    
    payload.execute();
}
EOF
done

#==============================================================================
# COMPILE EVERYTHING
#==============================================================================

echo ""
echo "ðŸ”¨ Compiling 500 advanced samples..."
echo "   This will take ~15-20 minutes"
echo ""

# Rust compilation
echo "Compiling Rust samples..."
for i in $(seq 1 100); do
    rustc -C opt-level=s -C strip=symbols /tmp/rust_adv_${i}.rs -o "$OUTPUT_DIR/rust_${i}" 2>/dev/null &
    if (( i % 10 == 0 )); then wait; echo "  Rust: $i/100"; fi
done
wait

for i in $(seq 401 500); do
    rustc -C opt-level=s -C strip=symbols /tmp/rust_poly_${i}.rs -o "$OUTPUT_DIR/rust_poly_${i}" 2>/dev/null &
    if (( i % 10 == 0 )); then wait; echo "  Rust polymorphic: $((i-400))/100"; fi
done
wait

# C compilation
echo "Compiling C samples..."
for i in $(seq 101 200); do
    gcc -O2 -s /tmp/c_adv_${i}.c -o "$OUTPUT_DIR/c_${i}" 2>/dev/null &
    if (( i % 10 == 0 )); then wait; echo "  C: $((i-100))/100"; fi
done
wait

# C++ compilation
echo "Compiling C++ samples..."
for i in $(seq 201 300); do
    g++ -O2 -s -std=c++17 /tmp/cpp_adv_${i}.cpp -o "$OUTPUT_DIR/cpp_${i}" 2>/dev/null &
    if (( i % 10 == 0 )); then wait; echo "  C++: $((i-200))/100"; fi
done
wait

# Go compilation
echo "Compiling Go samples..."
for i in $(seq 301 400); do
    go build -ldflags="-s -w" -o "$OUTPUT_DIR/go_${i}" /tmp/go_adv_${i}.go 2>/dev/null &
    if (( i % 10 == 0 )); then wait; echo "  Go: $((i-300))/100"; fi
done
wait

# Cleanup
rm /tmp/rust_adv_*.rs /tmp/rust_poly_*.rs /tmp/c_adv_*.c /tmp/cpp_adv_*.cpp /tmp/go_adv_*.go 2>/dev/null

echo ""
echo "âœ… DONE!"
echo "Created $(ls -1 $OUTPUT_DIR | wc -l) advanced synthetic malware samples"
echo "Disk usage: $(du -sh $OUTPUT_DIR | cut -f1)"
echo ""
echo "Sample breakdown:"
echo "  Rust (obfuscated):      100 samples"
echo "  C (low-level):          100 samples"
echo "  C++ (OOP):              100 samples"
echo "  Go (concurrent):        100 samples"
echo "  Rust (polymorphic):     100 samples"
echo ""
echo "Advanced features included:"
echo "  âœ“ String obfuscation (XOR encoding)"
echo "  âœ“ Anti-debug (timing, ptrace)"
echo "  âœ“ Anti-VM detection"
echo "  âœ“ High entropy (packed appearance)"
echo "  âœ“ Polymorphic variants"
echo "  âœ“ Multiple languages/compilers"
echo ""
echo "Next: Extract features:"
echo "  cd ../extractor"
echo "  ./target/release/arm64_extractor --input ../synthetic-malware/samples_advanced --output ../datasets/malicious_advanced.jsonl --label 1 --source advanced"
